{% extends 'base.html' %}
{% load static %}
{% load myfilters %}
{% block content %}

<form action="" method="post">{% csrf_token %}
	<p>{{ userlist_form.title|addclass:'input_class main centered' }}</p>
	
	<div class="list">
	{% for item in item_formset %}
		<div class="num">
		
		<!-- some nerd styling option -->
		{% if item.status.value == "done" %}
		{{ item.inner_order|addclass:'digits done' }}
		{% elif item.status.value == "in_progress" %}
		{{ item.inner_order|addclass:'digits in_progress' }}
		{% else %}
		{{ item.inner_order|addclass:'digits planned' }}
		{% endif %}
		
		{{ item.status|addclass:'status_style' }}
		<div class="item_style">{{ item.text|addclass:'input_class disable_drag' }}<h5>В последний раз обновлено в {{ item.updated_datetime.value }} пользователем {{ item.last_update_author.value }}</h5></div>
		
		{% if access_level >= 2 %}
		<div class="num_control">
			<div class="delete-row color_button" id={{ item.inner_order.value}}>Цвет</div>
			<!-- here is delete button -->
		</div>
		{% endif %}
		
		</div>
	{% endfor %}
	</div>
	<!-- <p>Описание: {{ userlist_form.description }}</p> -->
	<p class="centered more_padding">В последний раз список обновлен пользователем {{ userlist_form.last_update_author.value }} в {{ userlist_form.updated_datetime.value }}</p>
	{{ item_formset.management_form  }}
	{% if access_level >= 2 %}
	<p class="centered"><input type="submit" value="Сохранить"></p>
	{% endif %}
	
	
</form>


<!-- Include formset plugin - including jQuery dependency -->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="{% static 'js/jquery.formset.js' %}"></script>

<script>
    $("textarea").autoHeight()
	
	{% if access_level >= 2 %}
	$('.num').formset({
        deleteText: 'Удалить',
		deleteContainerClass: 'num_control', 
		addText: 'Добавить пункт',
    });
	
	

	
	$('.disable_drag')
        .on('focus', function(e) {
            $(this).closest('.num').attr("draggable", false);
        })
        .on('blur', function(e) {
            $(this).closest('.num').attr("draggable", true);
		})
		
	$(document)
        .on('click', '.color_button', function(e) {
            if ($(this).parent().siblings('.status_style').val()=="planned"){
				$(this).parent().siblings('.status_style').val("in_progress")
				$(this).parent().siblings('.digits').removeClass("planned")
				$(this).parent().siblings('.digits').addClass("in_progress")}
			else if ($(this).parent().siblings('.status_style').val()=="in_progress"){
				$(this).parent().siblings('.status_style').val("done")
				$(this).parent().siblings('.digits').removeClass("in_progress")
				$(this).parent().siblings('.digits').addClass("done")}
			else if ($(this).parent().siblings('.status_style').val()=="done"){
				$(this).parent().siblings('.status_style').val("planned")
				$(this).parent().siblings('.digits').removeClass("done")
				$(this).parent().siblings('.digits').addClass("planned")}

        })

	{% endif %}
</script>

<script>

/* JAVASCRIPT Section */

/* Moving items and change ordering*/
/* code from https://htmlacademy.ru/demos/65 */

const tasksListElement = document.querySelector(`.list`);
const taskElements = tasksListElement.querySelectorAll(`.num`);


for (const task of taskElements) {
  task.draggable = true;
}


tasksListElement.addEventListener(`dragstart`, (evt) => {
  evt.target.classList.add(`selected`);
});

tasksListElement.addEventListener(`dragend`, (evt) => {
  evt.target.classList.remove(`selected`);
});

const getNextElement = (cursorPosition, currentElement) => {
  const currentElementCoord = currentElement.getBoundingClientRect();
  const currentElementCenter = currentElementCoord.y + currentElementCoord.height / 2;
  
  const nextElement = (cursorPosition < currentElementCenter) ?
    currentElement :
    currentElement.nextElementSibling;
  
  return nextElement;
};

tasksListElement.addEventListener(`dragover`, (evt) => {
  evt.preventDefault();
  
  const activeElement = tasksListElement.querySelector(`.selected`);
  const currentElement = evt.target;
  const isMoveable = activeElement !== currentElement &&
    currentElement.classList.contains(`num`);
    
  if (!isMoveable) {
    return;
  }
  
  const nextElement = getNextElement(evt.clientY, currentElement);
  
  if (
    nextElement && 
    activeElement === nextElement.previousElementSibling ||
    activeElement === nextElement
  ) {
    return;
  }
		
	tasksListElement.insertBefore(activeElement, nextElement);

	//changind order id:
  //activeElement.value = "30"
  number_items_in_order();
  //inner_order_input = activeElement.children[0]
  /* if (inner_order_input.value === "2") {
    inner_order_input.value = "50";
  } */
});

function number_items_in_order() {
  //number digits items
  taskElements_2 = tasksListElement.querySelectorAll(`.num`);
  let i = 1;
  for (task of taskElements_2) {
	
	//styling for new row:
	if (task.children[0].value === "") {
		task.children[0].classList.remove('in_progress');
		task.children[0].classList.remove('done');
		task.children[0].classList.add('planned');
		task.children[2].children[1].innerHTML = "";
	}
	
	task.children[0].value = i;
	i++;
  }
	
  //add status to new row
  taskElements_4 = tasksListElement.querySelectorAll(`.status_style`);
  for (status_elemenet of taskElements_4) {
	if (status_elemenet.value === "") {
		status_elemenet.value = "planned";
	};
  }
}


/* prevent Enter key to save list,
but to tab to 1st item */
document.getElementByName('title').onkeypress = function (e) {
        if (e.which === 13) {
            document.getElementById("Text2").focus();
            return false;
        }
    };

</script>

{% endblock content %}